<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard</title>
<script type="module" src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js"></script>
<script type="module" src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js"></script>
<style>
body{ font-family:Arial,sans-serif; background:#f4f6f9; margin:0; padding:0;}
.container{ max-width:600px; margin:50px auto; background:white; padding:25px; border-radius:12px; box-shadow:0 3px 10px rgba(0,0,0,0.1);}
h2{text-align:center;}
input,button,select{ width:100%; padding:10px; margin:8px 0; border-radius:8px; border:1px solid #ccc; font-size:16px;}
button{ background:#00d1c1; color:white; border:none; cursor:pointer; font-weight:bold;}
button:hover{ background:#00b3a5;}
.alert{ color:red; display:none; margin:5px 0;}
.success{ color:green; display:none; margin:5px 0;}
.transactions{ margin-top:15px; }
.transactions h3{ margin-bottom:5px; font-size:1rem;}
.transactions ul{ padding-left:20px; }
</style>
</head>
<body>

<div class="container">
<h2>Admin Dashboard</h2>

<label>Search User (Email or Unique Code):</label>
<input type="text" id="searchInput" placeholder="Enter email or code">
<button id="searchBtn">Search</button>

<div class="alert" id="errorMsg"></div>
<div class="success" id="successMsg"></div>

<label>Current Balance:</label>
<input type="text" id="currentBalance" readonly>

<label>Add Funds:</label>
<input type="number" id="addAmount" placeholder="Amount to add">
<button id="addFundsBtn">Add Funds</button>

<div class="transactions" id="transactionsContainer"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
import { getFirestore, doc, getDoc, updateDoc, serverTimestamp, collection, addDoc, query, orderBy, limit, getDocs, where } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyCdX336VfLzIMZItn8eafwrPBlrBSKpxf0",
  authDomain: "flutter-ai-playground-51023.firebaseapp.com",
  projectId: "flutter-ai-playground-51023",
  storageBucket: "flutter-ai-playground-51023.firebasestorage.app",
  messagingSenderId: "589068038917",
  appId: "1:589068038917:web:b842384a52ec87c8213d6c"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// Elements
const searchInput = document.getElementById("searchInput");
const searchBtn = document.getElementById("searchBtn");
const currentBalanceInput = document.getElementById("currentBalance");
const addAmountInput = document.getElementById("addAmount");
const addFundsBtn = document.getElementById("addFundsBtn");
const errorMsg = document.getElementById("errorMsg");
const successMsg = document.getElementById("successMsg");
const transactionsContainer = document.getElementById("transactionsContainer");

let currentUserDoc = null;

// Search user by code or email
searchBtn.addEventListener("click", async () => {
  const input = searchInput.value.trim();
  errorMsg.style.display = "none";
  successMsg.style.display = "none";
  transactionsContainer.innerHTML = "";
  currentBalanceInput.value = "";
  addAmountInput.value = "";

  if(!input){
    errorMsg.innerText = "Enter email or unique code!";
    errorMsg.style.display = "block";
    return;
  }

  // Try as code first
  let userRef = doc(db, "users", input);
  let userSnap = await getDoc(userRef);

  // If not found, search by email
  if(!userSnap.exists()){
    const q = query(collection(db,"users"), where("email","==",input));
    const results = await getDocs(q);
    if(!results.empty){
      userRef = results.docs[0].ref;
      userSnap = results.docs[0];
    }
  }

  if(userSnap.exists()){
    currentUserDoc = userRef;
    const data = userSnap.data();
    currentBalanceInput.value = data.balance || 0;
    successMsg.innerText = `User found: ${data.name || "No Name"}`;
    successMsg.style.display = "block";
    loadTransactions(userRef.id);
  } else {
    currentUserDoc = null;
    errorMsg.innerText = "User not found!";
    errorMsg.style.display = "block";
  }
});

// Load last 5 transactions
async function loadTransactions(userId){
  const txQuery = query(collection(db, "users", userId, "transactions"), orderBy("timestamp","desc"), limit(5));
  const txSnapshot = await getDocs(txQuery);

  if(txSnapshot.empty){
    transactionsContainer.innerHTML = "<h3>Transactions:</h3><p>No transactions yet.</p>";
    return;
  }

  let html = "<h3>Last 5 Transactions:</h3><ul>";
  txSnapshot.forEach(doc => {
    const tx = doc.data();
    html += `<li>${tx.type.toUpperCase()}: KSH ${tx.amount} | ${tx.timestamp?.toDate().toLocaleString() || ""}</li>`;
  });
  html += "</ul>";
  transactionsContainer.innerHTML = html;
}

// Add funds
addFundsBtn.addEventListener("click", async () => {
  if(!currentUserDoc){
    errorMsg.innerText = "Search for a user first!";
    errorMsg.style.display = "block";
    return;
  }

  const amount = parseFloat(addAmountInput.value);
  if(!amount || amount <= 0){
    errorMsg.innerText = "Enter a valid amount!";
    errorMsg.style.display = "block";
    return;
  }

  const userSnap = await getDoc(currentUserDoc);
  const oldBalance = userSnap.data().balance || 0;
  const newBalance = oldBalance + amount;

  await updateDoc(currentUserDoc, {
    balance: newBalance,
    lastUpdated: serverTimestamp()
  });

  // Log transaction
  await addDoc(collection(currentUserDoc, "transactions"), {
    type: "credit",
    amount: amount,
    timestamp: serverTimestamp()
  });

  currentBalanceInput.value = newBalance;
  addAmountInput.value = "";
  successMsg.innerText = `Funds added! New balance: KSH ${newBalance}`;
  successMsg.style.display = "block";

  loadTransactions(currentUserDoc.id);
});
</script>

</body>
</html>
